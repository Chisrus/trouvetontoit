<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TrouvetonToit - Trouvez votre logement idéal</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            /* Nouveau dégradé de fond plus lumineux */
            background: linear-gradient(135deg, #e0eafc 0%, #cfdef3 100%);
            color: #333; /* Couleur de texte plus foncée pour le contraste */
            min-height: 10vh;
            overflow-x: hidden;
        }

        /* Arrière-plan animé plus clair */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background:
                radial-gradient(circle at 20% 80%, rgba(52, 152, 219, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(142, 68, 173, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(120, 119, 198, 0.05) 0%, transparent 50%);
            animation: float 20s ease-in-out infinite;
            pointer-events: none;
            z-index: -1;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            33% { transform: translateY(-20px) rotate(1deg); }
            66% { transform: translateY(10px) rotate(-1deg); }
        }

        .glassmorphism {
            background: rgba(255, 255, 255, 0.5); /* Effet de verre plus lumineux */
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .main-content {
            /* Arrière-plan du contenu principal plus clair */
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            color: #333; /* Texte plus foncé pour le contraste */
            box-shadow: 0 -20px 60px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
        }

        .tab-button {
            transition: all 0.3s ease;
        }

        .tab-button.active {
            /* Couleur d'onglet futuriste */
            background: linear-gradient(45deg, #3498db, #8e44ad);
            color: white;
            box-shadow: 0 10px 30px rgba(52, 152, 219, 0.3);
        }
        
        #virtualTourCanvas {
            width: 100%;
            height: 400px;
            border-radius: 1.5rem;
            display: block;
            touch-action: none;
            background: #f0f8ff; /* Arrière-plan plus clair pour la 3D */
        }

        .message-box, .premium-modal, #confirmation-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #ffffff; /* Couleur plus claire */
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.2);
            z-index: 200;
            display: none;
            text-align: center;
            color: #333; /* Texte foncé pour le contraste */
            max-width: 400px;
            animation: fadeIn 0.3s ease-out;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        .premium-modal ul {
            text-align: left;
            margin: 20px 0;
            list-style: disc; /* Utilisation de listes standard sans symboles */
            padding-left: 20px;
        }

        .premium-modal li {
            background: rgba(0, 0, 0, 0.05);
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 8px;
            display: list-item; /* Rétablit l'affichage normal des listes */
            color: #333;
        }

        .premium-modal li svg {
            display: none; /* Cache les SVGs s'ils étaient utilisés */
        }
        
        @keyframes gradient-shift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .animate-gradient-shift {
            background-size: 200% 200%;
            animation: gradient-shift 5s ease infinite;
        }

        .card-premium-recommended {
            border: 3px solid transparent;
            background: linear-gradient(#ffffff, #ffffff) padding-box,
                        linear-gradient(45deg, #3498db, #8e44ad) border-box;
            border-radius: 1.5rem;
        }

        .btn-neon-effect {
            box-shadow: 0 0 15px rgba(52, 152, 219, 0.8),
                        0 0 30px rgba(142, 68, 173, 0.6);
        }
        
        .apartment-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 1.5rem 1.5rem 0 0;
        }

    </style>
</head>
<body class="min-h-screen font-inter text-gray-800">
    <!-- En-tête -->
    <header class="glassmorphism sticky top-0 z-50 p-4">
        <nav class="container mx-auto flex justify-between items-center">
            <a href="#" class="text-3xl font-black bg-gradient-to-r from-cyan-400 via-blue-500 to-purple-600 text-transparent bg-clip-text animate-gradient-shift">TrouvetonToit</a>
            <div class="flex items-center space-x-4">
                <button onclick="openAuthModal('Connexion')" class="bg-gray-200 text-gray-800 rounded-full px-4 py-1 text-xs font-bold hover:bg-gray-300 transition duration-300">Connexion</button>
                <!-- Nouveau dégradé de bouton -->
                <button onclick="openAuthModal('S\'inscrire')" class="bg-gradient-to-r from-cyan-400 to-purple-500 text-white rounded-full px-4 py-1 text-xs font-bold hover:scale-105 transition-transform duration-300 btn-neon-effect">S'inscrire</button>
            </div>
        </nav>
    </header>

    <!-- Section Héros -->
    <section class="text-center py-16">
        <div class="container mx-auto px-4">
            <h1 class="text-5xl md:text-6xl lg:text-7xl font-black mb-4 animate-fadeInUp">Votre futur chez-vous vous attend.</h1>
            <p class="text-lg md:text-xl mb-8 opacity-80 animate-fadeInUp delay-100 text-gray-600">Entrez, visitez et projetez-vous comme jamais. Trouvez votre logement idéal.</p>
            <div class="glassmorphism rounded-full p-2 flex flex-col md:flex-row items-center max-w-2xl mx-auto shadow-xl animate-fadeInUp delay-200">
                <input type="text" id="search-input" placeholder="Ville, quartier..." class="flex-grow bg-transparent text-gray-700 placeholder-gray-400 p-4 md:p-2 focus:outline-none w-full md:w-auto">
                <button id="search-button" class="bg-gradient-to-r from-cyan-400 to-purple-500 text-white rounded-full px-8 py-4 md:py-2 font-bold mt-2 md:mt-0 md:ml-2 hover:scale-105 transition-transform duration-300 btn-neon-effect">Rechercher</button>
            </div>
        </div>
    </section>

    <!-- NOUVELLE SECTION : À propos de nous -->
    <section class="py-16 text-center bg-white rounded-b-3xl">
        <div class="container mx-auto px-4">
            <h2 class="text-4xl font-extrabold mb-4 text-gray-800">Votre logement idéal, en toute simplicité.</h2>
            <p class="text-lg text-gray-600 max-w-3xl mx-auto">
                TrouvetonToit révolutionne la recherche de logement. Notre plateforme vous permet de visiter virtuellement des biens immobiliers grâce à des modèles 3D immersifs. Fini les déplacements inutiles et les surprises, projetez-vous instantanément. Notre objectif ? Vous faire gagner du temps et prendre la meilleure décision pour votre futur chez-vous.
            </p>
            <div class="mt-8 grid grid-cols-1 md:grid-cols-3 gap-8 text-left">
                <div class="bg-gray-50 p-6 rounded-2xl shadow-sm hover:shadow-lg transition-shadow">
                    <h3 class="font-bold text-xl mb-2 text-cyan-500">Visites Immersives</h3>
                    <p class="text-gray-600">Explorez chaque recoin d'un appartement ou d'une maison comme si vous y étiez, directement depuis votre canapé.</p>
                </div>
                <div class="bg-gray-50 p-6 rounded-2xl shadow-sm hover:shadow-lg transition-shadow">
                    <h3 class="font-bold text-xl mb-2 text-purple-500">Projection Augmentée</h3>
                    <p class="text-gray-600">Notre outil d'aménagement en réalité augmentée vous permet de placer vos meubles virtuellement dans l'espace. Savoir si votre canapé rentre avant de signer est l'assurance de ne pas faire d'erreur coûteuse.</p>
                </div>
                <div class="bg-gray-50 p-6 rounded-2xl shadow-sm hover:shadow-lg transition-shadow">
                    <h3 class="font-bold text-xl mb-2 text-blue-500">Efficacité et Économie</h3>
                    <p class="text-gray-600">Faites votre choix rapidement et évitez les visites qui ne correspondent pas à vos attentes.</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Contenu Principal -->
    <main class="main-content rounded-t-3xl pt-8 pb-16">
        <div class="container mx-auto px-4">
            <!-- Navigation par onglets -->
            <div class="flex justify-center flex-wrap gap-2 mb-8">
                <button class="tab-button active p-4 rounded-full font-semibold text-gray-600 hover:text-gray-900" onclick="showTab('properties')">Propriétés</button>
                <button class="tab-button p-4 rounded-full font-semibold text-gray-600 hover:text-gray-900" onclick="showTab('pricing')">Premium</button>
                <button class="tab-button p-4 rounded-full font-semibold text-gray-600 hover:text-gray-900" onclick="showTab('virtual-tour')">Visite 3D</button>
                <button class="tab-button p-4 rounded-full font-semibold text-gray-600 hover:text-gray-900" onclick="showTab('furniture')">Calculateur AR</button>
            </div>
            
            <!-- Contenu des onglets -->
            <div id="properties" class="tab-content">
                <h2 class="text-center text-4xl font-extrabold mb-8 bg-gradient-to-r from-cyan-500 to-purple-600 text-transparent bg-clip-text">Propriétés disponibles en 3D</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8">
                    <div class="bg-white rounded-3xl overflow-hidden shadow-lg hover:shadow-2xl transition-transform transform hover:-translate-y-4">
                        <div class="w-full h-64 overflow-hidden rounded-t-3xl">
                           <img src="https://placehold.co/600x400/314e6f/ffffff?text=Appartement+moderne" alt="Image d'un appartement moderne" class="apartment-image">
                        </div>
                        <div class="p-6">
                            <h3 class="text-2xl font-bold text-gray-800 mb-2">Appartement moderne - Cocody</h3>
                            <p class="text-gray-600 mb-4">75 000 FCFA/mois</p>
                            <!-- Remplacement des symboles par du texte -->
                            <div class="flex items-center space-x-4 text-gray-500 mb-4">
                                <span>Chambres : 2</span>
                                <span>Salle de bain : 1</span>
                                <span>Surface : 65m²</span>
                            </div>
                            <button class="w-full bg-gradient-to-r from-cyan-500 to-purple-400 text-white p-3 rounded-full font-bold hover:from-cyan-600 hover:to-purple-500 transition duration-300 btn-neon-effect" onclick="showTab('virtual-tour')">Explorer en 3D</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="pricing" class="tab-content hidden">
                <h2 class="text-center text-4xl font-extrabold mb-8 bg-gradient-to-r from-cyan-400 to-purple-600 text-transparent bg-clip-text">Devenez Premium</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8">
                    <div class="card-premium-recommended p-8 rounded-3xl shadow-lg text-center relative transition-transform transform hover:scale-105">
                        <div class="absolute -top-4 left-1/2 transform -translate-x-1/2 bg-gradient-to-r from-cyan-500 to-purple-500 text-white rounded-full px-4 py-2 font-bold">Recommandé</div>
                        <h3 class="text-3xl font-bold mb-2 text-gray-800">Premium</h3>
                        <p class="text-gray-600 mb-6">2 500 FCFA/mois</p>
                        <ul class="text-left text-gray-700 mb-8 space-y-2">
                            <!-- Ligne de confusion supprimée. Le Premium offre l'illimité. -->
                            <li>Accès illimité aux visites 3D</li>
                            <li>Outil d'aménagement en réalité augmentée</li>
                            <li>Support prioritaire</li>
                        </ul>
                        <!-- Bouton mis à jour avec un ID pour attacher un événement de clic -->
                        <button id="choose-plan-button" class="w-full bg-gradient-to-r from-cyan-500 to-purple-400 text-white p-3 rounded-full font-bold hover:from-cyan-600 hover:to-purple-500 transition duration-300 btn-neon-effect" onclick="showPremiumModal(true)">Choisir ce plan</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="virtual-tour" class="tab-content hidden">
                <h2 class="text-center text-4xl font-extrabold mb-8 bg-gradient-to-r from-cyan-500 to-purple-400 text-transparent bg-clip-text">Lancer une Visite Virtuelle</h2>
                <p class="text-center text-gray-600 mb-8">Utilisez la souris ou le doigt pour faire pivoter, zoomer et vous déplacer dans le modèle 3D.</p>
                <canvas id="virtualTourCanvas"></canvas>
            </div>

            <div id="furniture" class="tab-content hidden">
                <h2 class="text-center text-4xl font-extrabold mb-8 bg-gradient-to-r from-cyan-500 to-purple-400 text-transparent bg-clip-text">Outil d'Aménagement (AR)</h2>
                <p class="text-center text-gray-600 mb-8">Cette fonctionnalité est en cours de développement. Elle vous permettra de vérifier si vos meubles s'adaptent à l'espace.</p>
                <div class="bg-gray-200 h-96 rounded-3xl flex items-center justify-center text-gray-500 text-2xl">
                    Fonctionnalité de Réalité Augmentée bientôt disponible
                </div>
            </div>
        </div>
    </main>

    <!-- Boîte de message -->
    <div id="message-box" class="message-box rounded-3xl">
        <h3 id="message-title" class="text-2xl font-bold mb-2 text-gray-800"></h3>
        <p id="message-content" class="text-gray-600 mb-4"></p>
        <button onclick="closeMessage()" class="bg-purple-500 text-white px-6 py-2 rounded-full font-bold hover:bg-purple-600 transition-colors">Fermer</button>
    </div>

    <!-- Modale d'authentification -->
    <div id="auth-modal" class="hidden fixed inset-0 z-10 bg-black bg-opacity-50 flex items-center justify-center">
        <div class="bg-white rounded-3xl p-8 max-w-sm w-full mx-4 relative shadow-2xl">
            <button onclick="closeAuthModal()" class="absolute top-4 right-4 text-gray-600 hover:text-gray-400 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
            <div class="flex justify-center mb-6">
                <button id="login-tab" class="auth-tab-btn active w-1/2 p-2 rounded-full font-bold text-gray-800 bg-gray-200">Connexion</button>
                <button id="signup-tab" class="auth-1/2 p-2 rounded-full font-bold text-gray-600">S'inscrire</button>
            </div>
            
            <!-- Formulaire de connexion -->
            <form id="login-form" class="auth-form">
                <h3 class="text-center text-3xl font-bold mb-6 text-gray-800">Connexion</h3>
                <input type="email" placeholder="Adresse email" class="w-full p-4 mb-4 rounded-xl border border-gray-300 bg-white text-gray-800 focus:outline-none focus:ring-2 focus:ring-cyan-400" required>
                <input type="password" placeholder="Mot de passe" class="w-full p-4 mb-6 rounded-xl border border-gray-300 bg-white text-gray-800 focus:outline-none focus:ring-2 focus:ring-cyan-400" required>
                <!-- Nouveau dégradé de bouton -->
                <button type="submit" class="w-full bg-gradient-to-r from-cyan-400 to-purple-500 text-white p-4 rounded-xl font-bold hover:shadow-lg transition duration-300 btn-neon-effect">Se connecter</button>
            </form>

            <!-- Formulaire d'inscription -->
            <form id="signup-form" class="auth-form hidden">
                <h3 class="text-center text-3xl font-bold mb-6 text-gray-800">S'inscrire</h3>
                <input type="text" placeholder="Nom complet" class="w-full p-4 mb-4 rounded-xl border border-gray-300 bg-white text-gray-800 focus:outline-none focus:ring-2 focus:ring-cyan-400" required>
                <select class="w-full p-4 mb-4 rounded-xl border border-gray-300 bg-white text-gray-800 focus:outline-none focus:ring-2 focus:ring-cyan-400" required>
                    <option value="" disabled selected>Je suis un...</option>
                    <option value="proprietaire">Propriétaire</option>
                    <option value="locataire">Locataire</option>
                    <option value="etudiant">Étudiant en architecture/bâtiment</option>
                    <option value="autre">Autre</option>
                </select>
                <input type="email" placeholder="Adresse email" class="w-full p-4 mb-4 rounded-xl border border-gray-300 bg-white text-gray-800 focus:outline-none focus:ring-2 focus:ring-cyan-400" required>
                <input type="tel" placeholder="Numéro de téléphone (facultatif)" class="w-full p-4 mb-4 rounded-xl border border-gray-300 bg-white text-gray-800 focus:outline-none focus:ring-2 focus:ring-cyan-400">
                <input type="text" placeholder="Adresse (facultatif)" class="w-full p-4 mb-4 rounded-xl border border-gray-300 bg-white text-gray-800 focus:outline-none focus:ring-2 focus:ring-cyan-400">
                <input type="password" placeholder="Mot de passe" class="w-full p-4 mb-4 rounded-xl border border-gray-300 bg-white text-gray-800 focus:outline-none focus:ring-2 focus:ring-cyan-400" required>
                <input type="password" placeholder="Confirmer le mot de passe" class="w-full p-4 mb-6 rounded-xl border border-gray-300 bg-white text-gray-800 focus:outline-none focus:ring-2 focus:ring-cyan-400" required>
                <!-- Nouveau dégradé de bouton -->
                <button type="submit" class="w-full bg-gradient-to-r from-cyan-400 to-purple-500 text-white p-4 rounded-xl font-bold hover:shadow-lg transition duration-300 btn-neon-effect">Créer un compte</button>
            </form>
        </div>
    </div>

    <!-- Modale de rappel Premium -->
    <div id="premium-modal" class="premium-modal rounded-3xl">
        <h3 class="text-2xl font-bold mb-2 text-gray-800">Débloquez tout le potentiel !</h3>
        <!-- MISE À JOUR: Texte corrigé -->
        <p class="text-gray-600 mb-4">Passez au plan Premium pour seulement 2 500 FCFA et obtenez un accès illimité aux visites 3D ! Vous avez atteint la limite de 4 visites gratuites.</p>
        <ul class="mb-4">
            <li>Accès illimité aux visites 3D</li>
            <li>Outil d'aménagement en réalité augmentée</li>
            <li>Support client prioritaire</li>
        </ul>
        <div class="bg-gray-100 p-4 rounded-xl text-sm text-gray-600 mb-4">
            <p>Paiement sécurisé via Wave ou Moov Money :</p>
            <p class="font-bold text-lg mt-1">0151239570</p>
        </div>
        <!-- Champ pour le numéro d'abonnement -->
        <input type="tel" id="subscription-phone" placeholder="Numéro de téléphone d'abonnement" class="w-full p-4 mb-4 rounded-xl border border-gray-300 bg-white text-gray-800 focus:outline-none focus:ring-2 focus:ring-cyan-400">
        <button id="validate-subscription-button" class="w-full bg-gradient-to-r from-cyan-400 to-purple-500 text-white p-4 rounded-xl font-bold hover:shadow-lg transition duration-300 btn-neon-effect mb-4">Valider</button>
        <button id="close-premium-button" onclick="closePremiumModal()" class="w-full bg-purple-500 text-white px-6 py-2 rounded-full font-bold hover:bg-purple-600 transition-colors">Fermer</button>
    </div>

    <!-- Boîte de confirmation -->
    <div id="confirmation-box" class="message-box rounded-3xl">
        <h3 id="confirmation-title" class="text-2xl font-bold mb-2 text-gray-800">Demande en cours</h3>
        <p id="confirmation-content" class="text-gray-600 mb-4">Veuillez patienter... Si vous êtes sûr d'avoir entré le bon numéro, l'accès premium sera activé sous peu.</p>
        <button onclick="closeConfirmationBox()" class="bg-purple-500 text-white px-6 py-2 rounded-full font-bold hover:bg-purple-600 transition-colors">Fermer</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, onSnapshot, doc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        window.onload = function() {
            // Variables Firebase globales
            const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
            const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

            let db, auth;
            let userId = null;
            let isPremium = false;
            // Variable pour compter les visites gratuites, stockée dans localStorage
            let visitCount = parseInt(localStorage.getItem('visitCount') || '0', 10);
            const MAX_FREE_VISITS = 4; // La nouvelle limite

            // Fonction pour afficher une boîte de message générique
            window.showMessage = function(title, content) {
                document.getElementById('message-title').textContent = title;
                document.getElementById('message-content').textContent = content;
                document.getElementById('message-box').style.display = 'block';
            }
            window.closeMessage = function() {
                document.getElementById('message-box').style.display = 'none';
            }

            // Fonction pour afficher/masquer la boîte de confirmation
            window.showConfirmationBox = function(title, content) {
                document.getElementById('confirmation-title').textContent = title;
                document.getElementById('confirmation-content').textContent = content;
                document.getElementById('confirmation-box').style.display = 'block';
            }
            window.closeConfirmationBox = function() {
                document.getElementById('confirmation-box').style.display = 'none';
            }

            // --- Fonctions de gestion de la modale d'authentification ---
            const authModal = document.getElementById('auth-modal');
            const loginTabBtn = document.getElementById('login-tab');
            const signupTabBtn = document.getElementById('signup-tab');
            const loginForm = document.getElementById('login-form');
            const signupForm = document.getElementById('signup-form');

            window.openAuthModal = function(formType) {
                authModal.classList.remove('hidden');
                if (formType === 'Connexion') {
                    showForm('login');
                } else {
                    showForm('signup');
                }
            }

            window.closeAuthModal = function() {
                authModal.classList.add('hidden');
            }

            function showForm(formId) {
                document.querySelectorAll('.auth-tab-btn').forEach(btn => btn.classList.remove('active', 'bg-gray-200'));
                document.querySelectorAll('.auth-form').forEach(form => form.classList.add('hidden'));

                if (formId === 'login') {
                    loginTabBtn.classList.add('active', 'bg-gray-200');
                    loginForm.classList.remove('hidden');
                } else {
                    signupTabBtn.classList.add('active', 'bg-gray-200');
                    signupForm.classList.remove('hidden');
                }
            }

            loginTabBtn.addEventListener('click', () => showForm('login'));
            signupTabBtn.addEventListener('click', () => showForm('signup'));
            
            // Three.js pour la visite virtuelle
            let scene, camera, renderer, controls;
            const virtualTourTab = document.getElementById('virtual-tour');

            function initThreeJS() {
                const canvas = document.getElementById('virtualTourCanvas');
                const width = canvas.clientWidth;
                const height = 400;

                // Scène
                scene = new THREE.Scene();
                scene.background = new THREE.Color(0xf0f8ff); // Arrière-plan clair

                // Caméra
                camera = new THREE.PerspectiveCamera(75, width / height, 0.1, 1000);
                camera.position.set(2, 2, 4);

                // Rendu
                renderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true });
                renderer.setSize(width, height);
                
                // Contrôles de la caméra (OrbitControls)
                controls = new THREE.OrbitControls(camera, renderer.domElement);
                controls.enableDamping = true;
                controls.dampingFactor = 0.05;
                controls.screenSpacePanning = false;
                controls.minDistance = 2; // Empêche de trop zoomer
                controls.maxDistance = 10; // Empêche de trop dézoomer

                // Création de l'intérieur de l'appartement (Code 3D inchangé)
                const wallMaterial = new THREE.MeshStandardMaterial({ color: 0xcfe2f3, metalness: 0.1, roughness: 0.8 });
                const floorMaterial = new THREE.MeshStandardMaterial({ color: 0xe6f3ff, metalness: 0.2, roughness: 0.5 });
                const windowMaterial = new THREE.MeshStandardMaterial({ color: 0x55b7ff, transparent: true, opacity: 0.1, metalness: 0.5 });
                
                // Sol
                const floor = new THREE.Mesh(new THREE.PlaneGeometry(5, 5), floorMaterial);
                floor.rotation.x = -Math.PI / 2;
                scene.add(floor);
                
                // Ajout d'une grille futuriste au sol
                const gridHelper = new THREE.GridHelper(5, 10, 0x00ffff, 0x00ffff);
                gridHelper.material.opacity = 0.2;
                gridHelper.material.transparent = true;
                scene.add(gridHelper);

                // Murs
                const wall1 = new THREE.Mesh(new THREE.BoxGeometry(5, 3, 0.1), wallMaterial); // Mur du fond
                wall1.position.set(0, 1.5, -2.5);
                scene.add(wall1);

                const wall2 = new THREE.Mesh(new THREE.BoxGeometry(5, 3, 0.1), wallMaterial); // Mur avant
                wall2.position.set(0, 1.5, 2.5);
                scene.add(wall2);
                
                const wall3 = new THREE.Mesh(new THREE.BoxGeometry(0.1, 3, 5), wallMaterial); // Mur gauche
                wall3.position.set(-2.5, 1.5, 0);
                scene.add(wall3);

                const wall4 = new THREE.Mesh(new THREE.BoxGeometry(0.1, 3, 5), wallMaterial); // Mur droit avec une ouverture
                const rightWall = new THREE.Group();
                const rightWallPart1 = new THREE.Mesh(new THREE.BoxGeometry(0.1, 3, 1.5), wallMaterial);
                rightWallPart1.position.z = 1.75;
                const rightWallPart2 = new THREE.Mesh(new THREE.BoxGeometry(0.1, 3, 1.5), wallMaterial);
                rightWallPart2.position.z = -1.75;
                rightWall.add(rightWallPart1);
                rightWall.add(rightWallPart2);
                rightWall.position.set(2.5, 1.5, 0);
                scene.add(rightWall);

                // Création d'une fenêtre sur le mur du fond
                const windowFrameGeometry = new THREE.BoxGeometry(2, 2, 0.2);
                const windowFrameMaterial = new THREE.MeshStandardMaterial({ color: 0x4a372f });
                const windowFrame = new THREE.Mesh(windowFrameGeometry, windowFrameMaterial);
                windowFrame.position.set(0, 1.5, -2.4);
                scene.add(windowFrame);

                const windowGlassGeometry = new THREE.BoxGeometry(1.8, 1.8, 0.1);
                const windowGlass = new THREE.Mesh(windowGlassGeometry, windowMaterial);
                windowGlass.position.set(0, 1.5, -2.45);
                scene.add(windowGlass);

                // Ajout de lumières
                const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
                scene.add(ambientLight);
                
                const directionalLight = new THREE.DirectionalLight(0xffffff, 0.6);
                directionalLight.position.set(10, 10, 10);
                scene.add(directionalLight);
                
                // Ajout de quelques orbes futuristes lumineuses
                const orbGeometry = new THREE.SphereGeometry(0.2, 32, 32);
                const orbMaterial = new THREE.MeshBasicMaterial({ color: 0x00ffff });
                const orbLight = new THREE.PointLight(0x00ffff, 1, 5);
                
                const orb1 = new THREE.Mesh(orbGeometry, orbMaterial);
                orb1.position.set(-2, 2.5, 2);
                orbLight.position.copy(orb1.position);
                scene.add(orb1);
                scene.add(orbLight);

                // Gestion du redimensionnement
                window.addEventListener('resize', onWindowResize, false);
                onWindowResize();
            }

            function onWindowResize() {
                if (!renderer) return;
                const canvas = document.getElementById('virtualTourCanvas');
                const width = canvas.clientWidth;
                const height = 400;
                camera.aspect = width / height;
                camera.updateProjectionMatrix();
                renderer.setSize(width, height);
            }

            // Boucle d'animation
            function animate() {
                requestAnimationFrame(animate);
                if (controls) {
                    controls.update(); // Met à jour les contrôles pour l'amortissement
                }
                if (renderer) {
                    renderer.render(scene, camera);
                }
            }

            // Fonction pour gérer les changements d'onglets
            window.showTab = function(tabId) {
                document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
                document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                
                // Si la cible n'est pas "virtual-tour", on affiche juste l'onglet
                if (tabId !== 'virtual-tour') {
                    document.getElementById(tabId).classList.remove('hidden');
                    document.querySelector(`[onclick="showTab('${tabId}')"]`).classList.add('active');
                    return;
                }

                // Logique spécifique pour l'onglet 'virtual-tour'
                if (isPremium) {
                    // Utilisateur Premium : accès illimité
                    document.getElementById(tabId).classList.remove('hidden');
                    document.querySelector(`[onclick="showTab('${tabId}')"]`).classList.add('active');
                    initThreeJS();
                    animate();
                } else {
                    // Utilisateurs non-Premium : accès limité à 4 visites
                    if (visitCount < MAX_FREE_VISITS) {
                        visitCount++;
                        localStorage.setItem('visitCount', visitCount.toString());
                        
                        document.getElementById(tabId).classList.remove('hidden');
                        document.querySelector(`[onclick="showTab('${tabId}')"]`).classList.add('active');

                        showMessage('Visite virtuelle (Gratuite)', `Ceci est votre visite numéro ${visitCount} sur ${MAX_FREE_VISITS}. Il vous reste ${MAX_FREE_VISITS - visitCount} visites gratuites. Passez Premium pour un accès illimité.`);
                        initThreeJS();
                        animate();
                    } else {
                        // Limite atteinte
                        showPremiumModal(true);
                        // Afficher un message spécifique et revenir à l'onglet propriétés
                        showMessage('Limite de visites atteinte', `Vous avez atteint la limite de ${MAX_FREE_VISITS} visites gratuites. Veuillez passer au plan Premium pour continuer à explorer en 3D.`);
                        showTab('properties'); // Revenir à l'onglet "Propriétés"
                    }
                }
            }
            
            // Gérer le clic sur le bouton de recherche
            const searchInput = document.getElementById('search-input');
            const searchButton = document.getElementById('search-button');

            searchButton.addEventListener('click', () => {
                const query = searchInput.value.trim();
                if (query) {
                    showMessage('Aucune offre disponible', `Il n'y a pas encore d'offres pour "${query}". Réessayez plus tard !`);
                } else {
                    showMessage('Recherche vide', 'Veuillez entrer une ville ou un quartier pour lancer la recherche.');
                }
            });

            // --- Fonctionnalité de rappel Premium ---
            const premiumModal = document.getElementById('premium-modal');
            let reminderInterval;

            window.showPremiumModal = function(forceShow = false) {
                // Affiche la modale Premium seulement si l'utilisateur n'est pas premium et que l'affichage est forcé
                if (!isPremium && forceShow) {
                    premiumModal.style.display = 'block';
                }
            }

            window.closePremiumModal = function() {
                premiumModal.style.display = 'none';
            }
            
            const subscriptionPhoneInput = document.getElementById('subscription-phone');
            const validateSubscriptionButton = document.getElementById('validate-subscription-button');

            validateSubscriptionButton.addEventListener('click', () => {
                const phoneNumber = subscriptionPhoneInput.value.trim();
                if (phoneNumber) {
                    closePremiumModal();
                    // On simule ici la validation du paiement et l'envoi de la demande
                    showConfirmationBox("Demande de vérification", "Veuillez patienter... Nous vérifions votre paiement. Si vous êtes sûr d'avoir entré le bon numéro, l'accès premium sera activé sous peu.");
                } else {
                    showMessage("Numéro de téléphone manquant", "Veuillez entrer le numéro de téléphone utilisé pour votre abonnement.");
                }
            });

            function startPremiumReminder() {
                clearInterval(reminderInterval);
                if (!isPremium) {
                    // La logique de rappel est désormais intégrée à showTab.
                }
            }
            
            // Écouteur d'événement pour le bouton "Choisir ce plan"
            const choosePlanButton = document.getElementById('choose-plan-button');
            if (choosePlanButton) {
                choosePlanButton.addEventListener('click', () => {
                    showPremiumModal(true); // Forcer l'affichage de la modale
                });
            }

            const closePremiumButton = document.getElementById('close-premium-button');
            closePremiumButton.addEventListener('click', closePremiumModal);

            // --- Initialisation de Firebase et gestion de l'état d'authentification ---
            
            initializeApp(firebaseConfig);
            auth = getAuth();
            db = getFirestore();
            console.debug('Firebase initialisé. En attente de l\'état d\'authentification.');

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    console.log('Utilisateur connecté :', userId);
                    
                    // Commencer à écouter les données de l'utilisateur dans Firestore
                    const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/profile/data`);
                    onSnapshot(userDocRef, (docSnap) => {
                        if (docSnap.exists()) {
                            const data = docSnap.data();
                            // Mise à jour de l'état premium
                            isPremium = data.isPremium || false;
                            console.log('Statut premium de l\'utilisateur :', isPremium);
                        } else {
                            // Le document utilisateur n'existe pas, il n'est pas premium
                            isPremium = false;
                            console.log('L\'utilisateur n\'a pas de profil premium.');
                        }
                        startPremiumReminder();
                    }, (error) => {
                        console.error('Erreur lors de l\'écoute des données utilisateur :', error);
                    });

                } else {
                    console.log('Utilisateur déconnecté (anonyme).');
                    userId = null;
                    isPremium = false;
                    startPremiumReminder();
                }
            });

            // Gérer la connexion avec le jeton personnalisé
            async function handleCustomAuth() {
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                        console.log("Connecté avec le jeton personnalisé.");
                    } else {
                        await signInAnonymously(auth);
                        console.log("Connecté anonymement.");
                    }
                } catch (error) {
                    console.error("Erreur d'authentification Firebase :", error);
                }
            }
            handleCustomAuth();
            
            // Afficher l'onglet par défaut au chargement
            showTab('properties');
        };
    </script>
</body>
</html>
