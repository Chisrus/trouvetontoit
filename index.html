<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TrouvetonToit - Visite 3D et AR</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #e0eafc 0%, #cfdef3 100%);
            color: #333;
            min-height: 10vh;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background:
                radial-gradient(circle at 20% 80%, rgba(52, 152, 219, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(142, 68, 173, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(120, 119, 198, 0.05) 0%, transparent 50%);
            animation: float 20s ease-in-out infinite;
            pointer-events: none;
            z-index: -1;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            33% { transform: translateY(-20px) rotate(1deg); }
            66% { transform: translateY(10px) rotate(-1deg); }
        }

        .glassmorphism {
            background: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .main-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            color: #333;
            box-shadow: 0 -20px 60px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
        }

        .tab-button {
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .tab-button.active {
            background: linear-gradient(45deg, #3498db, #8e44ad);
            color: white;
            box-shadow: 0 10px 30px rgba(52, 152, 219, 0.3);
        }

        .hover-lift {
            transition: transform 0.3s ease-out, box-shadow 0.3s ease-out;
        }
        .hover-lift:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
        }
        
        #tab-content-container {
            position: relative;
        }

        @keyframes fadeInSlide {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeOutSlide {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(-10px); }
        }

        .fade-in-slide {
            animation: fadeInSlide 0.4s ease-out forwards;
        }

        .fade-out-slide {
            animation: fadeOutSlide 0.3s ease-in forwards;
        }
        
        #virtualTourCanvas {
            width: 100%;
            height: 400px;
            border-radius: 1.5rem;
            display: block;
            touch-action: none;
            background: #f0f8ff;
        }

        .message-box, .premium-modal, #confirmation-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #ffffff;
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.2);
            z-index: 200;
            display: none;
            text-align: center;
            color: #333;
            max-width: 400px;
            animation: fadeIn 0.3s ease-out;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        .premium-modal ul {
            text-align: left;
            margin: 20px 0;
            list-style: disc;
            padding-left: 20px;
        }

        .premium-modal li {
            background: rgba(0, 0, 0, 0.05);
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 8px;
            display: list-item;
            color: #333;
        }
        
        @keyframes gradient-shift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .animate-gradient-shift {
            background-size: 200% 200%;
            animation: gradient-shift 5s ease infinite;
        }

        .card-premium-recommended {
            border: 3px solid transparent;
            background: linear-gradient(#ffffff, #ffffff) padding-box,
                        linear-gradient(45deg, #3498db, #8e44ad) border-box;
            border-radius: 1.5rem;
        }

        .btn-neon-effect {
            box-shadow: 0 0 15px rgba(52, 152, 219, 0.8),
                        0 0 30px rgba(142, 68, 173, 0.6);
            transition: all 0.3s ease-out;
        }
        
        .apartment-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 1.5rem 1.5rem 0 0;
        }
        
        .line-clamp-3 {
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

    </style>
</head>
<body class="min-h-screen font-inter text-gray-800">
    <!-- En-tête -->
    <header class="glassmorphism sticky top-0 z-50 p-4">
        <nav class="container mx-auto flex justify-between items-center">
            <a href="#" class="text-3xl font-black bg-gradient-to-r from-cyan-400 via-blue-500 to-purple-600 text-transparent bg-clip-text animate-gradient-shift">TrouvetonToit</a>
            <div class="flex items-center space-x-4">
                <button onclick="openAuthModal('Connexion')" class="bg-gray-200 text-gray-800 rounded-full px-4 py-1 text-xs font-bold hover:bg-gray-300 transition duration-300">Connexion</button>
                <button onclick="openAuthModal('S\'inscrire')" class="bg-gradient-to-r from-cyan-400 to-purple-500 text-white rounded-full px-4 py-1 text-xs font-bold hover:scale-105 transition-transform duration-300 btn-neon-effect">S'inscrire</button>
            </div>
        </nav>
    </header>

    <!-- Section Héros -->
    <section class="text-center py-16">
        <div class="container mx-auto px-4">
            <h1 class="text-5xl md:text-6xl lg:text-7xl font-black mb-4 animate-fadeInUp">Votre futur chez-vous vous attend.</h1>
            <p class="text-lg md:text-xl mb-8 opacity-80 animate-fadeInUp delay-100 text-gray-600">Entrez, visitez et projetez-vous comme jamais. Trouvez votre logement idéal.</p>
            <div class="glassmorphism rounded-full p-2 flex flex-col md:flex-row items-center max-w-2xl mx-auto shadow-xl animate-fadeInUp delay-200">
                <input type="text" id="search-input" placeholder="Ville, quartier..." class="flex-grow bg-transparent text-gray-700 placeholder-gray-400 p-4 md:p-2 focus:outline-none w-full md:w-auto">
                <button id="search-button" class="bg-gradient-to-r from-cyan-400 to-purple-500 text-white rounded-full px-8 py-4 md:py-2 font-bold mt-2 md:mt-0 md:ml-2 hover:scale-105 transition-transform duration-300 btn-neon-effect">Rechercher</button>
            </div>
        </div>
    </section>

    <!-- Section À propos de nous -->
    <section class="py-16 text-center bg-white rounded-b-3xl">
        <div class="container mx-auto px-4">
            <h2 class="text-4xl font-extrabold mb-4 text-gray-800">Votre logement idéal, en toute simplicité.</h2>
            <p class="text-lg text-gray-600 max-w-3xl mx-auto">
                TrouvetonToit révolutionne la recherche de logement. Notre plateforme vous permet de visiter virtuellement des biens immobiliers grâce à des modèles 3D immersifs. Fini les déplacements inutiles et les surprises, projetez-vous instantanément. Notre objectif ? Vous faire gagner du temps et prendre la meilleure décision pour votre futur chez-vous.
            </p>
            <div class="mt-8 grid grid-cols-1 md:grid-cols-3 gap-8 text-left">
                <div class="bg-gray-50 p-6 rounded-2xl shadow-sm hover-lift">
                    <h3 class="font-bold text-xl mb-2 text-cyan-500">Visites Immersives</h3>
                    <p class="text-gray-600">Explorez chaque recoin d'un appartement ou d'une maison comme si vous y étiez, directement depuis votre canapé.</p>
                </div>
                <div class="bg-gray-50 p-6 rounded-2xl shadow-sm hover-lift">
                    <h3 class="font-bold text-xl mb-2 text-purple-500">Projection Augmentée</h3>
                    <p class="text-gray-600">Notre outil d'aménagement en réalité augmentée vous permet de placer vos meubles virtuellement dans l'espace. Savoir si votre canapé rentre avant de signer est l'assurance de ne pas faire d'erreur coûteuse.</p>
                </div>
                <div class="bg-gray-50 p-6 rounded-2xl shadow-sm hover-lift">
                    <h3 class="font-bold text-xl mb-2 text-blue-500">Efficacité et Économie</h3>
                    <p class="text-gray-600">Faites votre choix rapidement et évitez les visites qui ne correspondent pas à vos attentes.</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Contenu Principal -->
    <main class="main-content rounded-t-3xl pt-8 pb-16">
        <div class="container mx-auto px-4">
            <!-- Navigation par onglets -->
            <div class="flex justify-center flex-wrap gap-2 mb-8">
                <button class="tab-button active p-4 rounded-full font-semibold text-gray-600 hover:text-gray-900" onclick="showTab('properties')">Propriétés</button>
                <button class="tab-button p-4 rounded-full font-semibold text-gray-600 hover:text-gray-900" onclick="showTab('pricing')">Premium</button>
                <button class="tab-button p-4 rounded-full font-semibold text-gray-600 hover:text-gray-900" onclick="showTab('virtual-tour')">Visite 3D</button>
                <button class="tab-button p-4 rounded-full font-semibold text-gray-600 hover:text-gray-900" onclick="showTab('furniture')">Calculateur AR</button>
            </div>
            
            <!-- Conteneur d'onglets pour la transition fluide -->
            <div id="tab-content-container" class="min-h-[500px]">
                
                <div id="properties" class="tab-content">
                    <h2 class="text-center text-4xl font-extrabold mb-8 bg-gradient-to-r from-cyan-500 to-purple-600 text-transparent bg-clip-text">Propriétés disponibles (Scraping)</h2>
                    
                    <!-- Conteneur où le JS va injecter les annonces -->
                    <div id="listings-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8">
                        <!-- Annonces injectées ici par renderProperties() -->
                    </div>

                    <div id="empty-state" class="text-center mt-12 p-8 bg-white rounded-xl shadow-lg" style="display: none;">
                        <p class="text-2xl font-semibold text-gray-500">Aucune annonce à afficher pour le moment.</p>
                    </div>

                    <!-- NOUVEAU BOUTON D'EXPORTATION -->
                    <div class="mt-12 max-w-sm mx-auto p-4 bg-white rounded-2xl shadow-xl">
                        <p class="text-center text-gray-700 mb-4 font-semibold">Exporter les données de la liste</p>
                         <button class="w-full bg-gradient-to-r from-teal-500 to-green-500 text-white p-3 rounded-full font-bold hover:from-teal-600 hover:to-green-600 transition duration-300" onclick="exportData()">Exporter les données (JSON & CSV)</button>
                    </div>
                </div>

                <div id="pricing" class="tab-content hidden">
                    <h2 class="text-center text-4xl font-extrabold mb-8 bg-gradient-to-r from-cyan-400 to-purple-600 text-transparent bg-clip-text">Devenez Premium</h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8 justify-center">
                        <div class="bg-white p-8 rounded-3xl shadow-lg text-center relative transition-transform transform hover-lift">
                            <h3 class="text-3xl font-bold mb-2 text-gray-800">Forfait Essai 3D</h3>
                            <p class="text-gray-600 mb-6">2 500 FCFA (paiement unique)</p>
                            <ul class="text-left text-gray-700 mb-8 space-y-2">
                                <li>**4 Visites** de maisons/appartements en 3D</li>
                                <li>Accès limité à l'outil d'aménagement AR</li>
                                <li>Valable 7 jours</li>
                            </ul>
                            <button class="w-full bg-gradient-to-r from-cyan-500 to-purple-400 text-white p-3 rounded-full font-bold hover:from-cyan-600 hover:to-purple-500 transition duration-300 btn-neon-effect" onclick="showPremiumModal(true)">Choisir ce plan</button>
                        </div>

                        <div class="card-premium-recommended p-8 rounded-3xl shadow-lg text-center relative transition-transform transform hover-lift">
                            <div class="absolute -top-4 left-1/2 transform -translate-x-1/2 bg-gradient-to-r from-cyan-500 to-purple-500 text-white rounded-full px-4 py-2 font-bold">Illimité</div>
                            <h3 class="text-3xl font-bold mb-2 text-gray-800">Accès Total</h3>
                            <p class="text-gray-600 mb-6">5 000 FCFA/mois</p>
                            <ul class="text-left text-gray-700 mb-8 space-y-2">
                                <li>Accès **illimité** aux visites 3D</li>
                                <li>Outil d'aménagement en réalité augmentée sans restriction</li>
                                <li>Support prioritaire</li>
                            </ul>
                            <button class="w-full bg-gradient-to-r from-cyan-500 to-purple-400 text-white p-3 rounded-full font-bold hover:from-cyan-600 hover:to-purple-500 transition duration-300 btn-neon-effect" onclick="showPremiumModal(true)">Choisir ce plan</button>
                        </div>
                    </div>
                </div>

                <div id="virtual-tour" class="tab-content hidden">
                    <h2 class="text-center text-4xl font-extrabold mb-8 bg-gradient-to-r from-cyan-500 to-purple-400 text-transparent bg-clip-text">Lancer une Visite Virtuelle</h2>
                    <p class="text-center text-gray-600 mb-8">Utilisez la souris ou le doigt pour faire pivoter, zoomer et vous déplacer dans le modèle 3D.</p>
                    <canvas id="virtualTourCanvas"></canvas>
                </div>

                <div id="furniture" class="tab-content hidden">
                    <h2 class="text-center text-4xl font-extrabold mb-8 bg-gradient-to-r from-cyan-500 to-purple-400 text-transparent bg-clip-text">Outil d'Aménagement (AR)</h2>
                    <p class="text-center text-gray-600 mb-8">Cette fonctionnalité est en cours de développement. Elle vous permettra de vérifier si vos meubles s'adaptent à l'espace.</p>
                    <div class="bg-gray-200 h-96 rounded-3xl flex items-center justify-center text-gray-500 text-2xl">
                        Fonctionnalité de Réalité Augmentée bientôt disponible
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Boîte de message -->
    <div id="message-box" class="message-box rounded-3xl">
        <h3 id="message-title" class="text-2xl font-bold mb-2 text-gray-800"></h3>
        <p id="message-content" class="text-gray-600 mb-4"></p>
        <button onclick="closeMessage()" class="bg-purple-500 text-white px-6 py-2 rounded-full font-bold hover:bg-purple-600 transition-colors">Fermer</button>
    </div>

    <!-- Modale d'authentification -->
    <div id="auth-modal" class="hidden fixed inset-0 z-10 bg-black bg-opacity-50 flex items-center justify-center">
        <div class="bg-white rounded-3xl p-8 max-w-sm w-full mx-4 relative shadow-2xl">
            <button onclick="closeAuthModal()" class="absolute top-4 right-4 text-gray-600 hover:text-gray-400 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
            <div class="flex justify-center mb-6">
                <button id="login-tab" class="auth-tab-btn active w-1/2 p-2 rounded-full font-bold text-gray-800 bg-gray-200">Connexion</button>
                <button id="signup-tab" class="auth-tab-btn w-1/2 p-2 rounded-full font-bold text-gray-600">S'inscrire</button>
            </div>
            
            <!-- Formulaire de connexion -->
            <form id="login-form" class="auth-form">
                <h3 class="text-center text-3xl font-bold mb-6 text-gray-800">Connexion</h3>
                <input type="email" placeholder="Adresse email" class="w-full p-4 mb-4 rounded-xl border border-gray-300 bg-white text-gray-800 focus:outline-none focus:ring-2 focus:ring-cyan-400" required>
                <input type="password" placeholder="Mot de passe" class="w-full p-4 mb-6 rounded-xl border border-gray-300 bg-white text-gray-800 focus:outline-none focus:ring-2 focus:ring-cyan-400" required>
                <button type="submit" class="w-full bg-gradient-to-r from-cyan-400 to-purple-500 text-white p-4 rounded-xl font-bold hover:shadow-lg transition duration-300 btn-neon-effect">Se connecter</button>
            </form>

            <!-- Formulaire d'inscription -->
            <form id="signup-form" class="auth-form hidden">
                <h3 class="text-center text-3xl font-bold mb-6 text-gray-800">S'inscrire</h3>
                <input type="text" placeholder="Nom complet" class="w-full p-4 mb-4 rounded-xl border border-gray-300 bg-white text-gray-800 focus:outline-none focus:ring-2 focus:ring-cyan-400" required>
                <select class="w-full p-4 mb-4 rounded-xl border border-gray-300 bg-white text-gray-800 focus:outline-none focus:ring-2 focus:ring-cyan-400" required>
                    <option value="" disabled selected>Je suis un...</option>
                    <option value="proprietaire">Propriétaire</option>
                    <option value="locataire">Locataire</option>
                    <option value="etudiant">Étudiant en architecture/bâtiment</option>
                    <option value="autre">Autre</option>
                </select>
                <input type="email" placeholder="Adresse email" class="w-full p-4 mb-4 rounded-xl border border-gray-300 bg-white text-gray-800 focus:outline-none focus:ring-2 focus:ring-cyan-400" required>
                <input type="tel" placeholder="Numéro de téléphone (facultatif)" class="w-full p-4 mb-4 rounded-xl border border-gray-300 bg-white text-gray-800 focus:outline-none focus:ring-2 focus:ring-cyan-400">
                <input type="text" placeholder="Adresse (facultatif)" class="w-full p-4 mb-4 rounded-xl border border-gray-300 bg-white text-gray-800 focus:outline-none focus:ring-2 focus:ring-cyan-400">
                <input type="password" placeholder="Mot de passe" class="w-full p-4 mb-4 rounded-xl border border-gray-300 bg-white text-gray-800 focus:outline-none focus:ring-2 focus:ring-cyan-400" required>
                <input type="password" placeholder="Confirmer le mot de passe" class="w-full p-4 mb-6 rounded-xl border border-gray-300 bg-white text-gray-800 focus:outline-none focus:ring-2 focus:ring-cyan-400" required>
                <button type="submit" class="w-full bg-gradient-to-r from-cyan-400 to-purple-500 text-white p-4 rounded-xl font-bold hover:shadow-lg transition duration-300 btn-neon-effect">Créer un compte</button>
            </form>
        </div>
    </div>

    <!-- Modale de rappel Premium -->
    <div id="premium-modal" class="premium-modal rounded-3xl">
        <h3 class="text-2xl font-bold mb-2 text-gray-800">Débloquez l'accès 3D !</h3>
        <p class="text-gray-600 mb-4" id="premium-modal-content">Accédez instantanément à la visite virtuelle en payant le forfait **Essai 3D** à 2 500 FCFA. Ce forfait vous donne droit à 4 visites.</p>
        <ul class="mb-4">
            <li>4 visites de maisons/appartements en 3D</li>
            <li>Accès limité à l'outil d'aménagement AR</li>
            <li>Valable 7 jours</li>
        </ul>
        <div class="bg-gray-100 p-4 rounded-xl text-sm text-gray-600 mb-4">
            <p>Paiement sécurisé via **Moov Money** ou **Wave** :</p>
            <p class="font-bold text-lg mt-1">0151239570</p>
        </div>
        <input type="tel" id="subscription-phone" placeholder="Numéro de téléphone de paiement" class="w-full p-4 mb-4 rounded-xl border border-gray-300 bg-white text-gray-800 focus:outline-none focus:ring-2 focus:ring-cyan-400">
        <button id="validate-subscription-button" class="w-full bg-gradient-to-r from-cyan-400 to-purple-500 text-white p-4 rounded-xl font-bold hover:shadow-lg transition duration-300 btn-neon-effect mb-4">Valider le paiement</button>
        <button id="close-premium-button" onclick="closePremiumModal()" class="w-full bg-purple-500 text-white px-6 py-2 rounded-full font-bold hover:bg-purple-600 transition-colors">Fermer</button>
    </div>

    <!-- Boîte de confirmation -->
    <div id="confirmation-box" class="message-box rounded-3xl">
        <h3 id="confirmation-title" class="text-2xl font-bold mb-2 text-gray-800">Demande en cours</h3>
        <p id="confirmation-content" class="text-gray-600 mb-4">Veuillez patienter... Si vous êtes sûr d'avoir entré le bon numéro, l'accès premium sera activé sous peu.</p>
        <button onclick="closeConfirmationBox()" class="bg-purple-500 text-white px-6 py-2 rounded-full font-bold hover:bg-purple-600 transition-colors">Fermer</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, onSnapshot, doc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- 1. DONNÉES D'ANNONCES (VOS RÉSULTATS DE SCRAPING) ---
        // REMPLACEZ CE TABLEAU PAR LES RÉSULTATS RÉELS DE VOTRE SCRAPING.
        const scrapedListings = [
            {
                title: "Appartement T3 Rénové près du centre-ville",
                price: "245 000 €",
                description: "Spacieux T3 lumineux de 65m² avec balcon. Proche des commodités et des transports en commun.",
                link: "https://example.com/annonce1",
                imageUrl: "https://placehold.co/400x300/4F46E5/ffffff?text=Appartement+1"
            },
            {
                title: "Maison de campagne avec grand jardin (1000m²)",
                price: "480 000 €",
                description: "Belle propriété de 120m² habitable, 4 chambres, cheminée. Idéal pour les familles ou télétravail.",
                link: "https://example.com/annonce2",
                imageUrl: "https://placehold.co/400x300/10B981/ffffff?text=Maison+2"
            },
            {
                title: "Studio Meublé – Idéal Investissement Locatif",
                price: "95 000 €",
                description: "Studio de 20m² entièrement équipé, faible charge, forte demande locative étudiante.",
                link: "https://example.com/annonce3",
                imageUrl: "https://placehold.co/400x300/F59E0B/ffffff?text=Studio+3"
            },
            {
                title: "Loft Industriel avec terrasse sur le toit",
                price: "599 000 €",
                description: "Espace unique de 150m² style New-Yorkais, grande hauteur sous plafond, quartier prisé.",
                link: "https://example.com/annonce4",
                imageUrl: "https://placehold.co/400x300/EF4444/ffffff?text=Loft+4"
            },
             {
                title: "Villa 5 pièces - Cocody Ambassades",
                price: "150 000 FCFA/mois",
                description: "Grande villa avec piscine et sécurité 24/24. Idéale pour expatriés.",
                link: "https://example.com/annonce5",
                imageUrl: "https://placehold.co/400x300/8e44ad/ffffff?text=Villa+Cocody"
            }
        ];
        
        // Nettoyage et initialisation de Three.js
        let scene, camera, renderer, controls;
        
        function initThreeJS() {
            // Initialisation de la scène 3D
            const canvas = document.getElementById('virtualTourCanvas');
            const width = canvas.clientWidth;
            const height = 400;

            scene = new THREE.Scene();
            scene.background = new THREE.Color(0xf0f8ff);

            camera = new THREE.PerspectiveCamera(75, width / height, 0.1, 1000);
            camera.position.set(2, 2, 4);

            renderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true });
            renderer.setSize(width, height);
            
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.screenSpacePanning = false;
            controls.minDistance = 2;
            controls.maxDistance = 10;

            // Création de l'intérieur de l'appartement (même logique que précédemment)
            const wallMaterial = new THREE.MeshStandardMaterial({ color: 0xcfe2f3, metalness: 0.1, roughness: 0.8 });
            const floorMaterial = new THREE.MeshStandardMaterial({ color: 0xe6f3ff, metalness: 0.2, roughness: 0.5 });
            const windowMaterial = new THREE.MeshStandardMaterial({ color: 0x55b7ff, transparent: true, opacity: 0.1, metalness: 0.5 });
            
            const floor = new THREE.Mesh(new THREE.PlaneGeometry(5, 5), floorMaterial);
            floor.rotation.x = -Math.PI / 2;
            scene.add(floor);
            
            const gridHelper = new THREE.GridHelper(5, 10, 0x00ffff, 0x00ffff);
            gridHelper.material.opacity = 0.2;
            gridHelper.material.transparent = true;
            scene.add(gridHelper);

            // Murs
            const wall1 = new THREE.Mesh(new THREE.BoxGeometry(5, 3, 0.1), wallMaterial); wall1.position.set(0, 1.5, -2.5); scene.add(wall1);
            const wall2 = new THREE.Mesh(new THREE.BoxGeometry(5, 3, 0.1), wallMaterial); wall2.position.set(0, 1.5, 2.5); scene.add(wall2);
            const wall3 = new THREE.Mesh(new THREE.BoxGeometry(0.1, 3, 5), wallMaterial); wall3.position.set(-2.5, 1.5, 0); scene.add(wall3);

            const rightWall = new THREE.Group();
            const rightWallPart1 = new THREE.Mesh(new THREE.BoxGeometry(0.1, 3, 1.5), wallMaterial);
            rightWallPart1.position.z = 1.75;
            const rightWallPart2 = new THREE.Mesh(new THREE.BoxGeometry(0.1, 3, 1.5), wallMaterial);
            rightWallPart2.position.z = -1.75;
            rightWall.add(rightWallPart1);
            rightWall.add(rightWallPart2);
            rightWall.position.set(2.5, 1.5, 0);
            scene.add(rightWall);

            const windowFrameGeometry = new THREE.BoxGeometry(2, 2, 0.2);
            const windowFrameMaterial = new THREE.MeshStandardMaterial({ color: 0x4a372f });
            const windowFrame = new THREE.Mesh(windowFrameGeometry, windowFrameMaterial);
            windowFrame.position.set(0, 1.5, -2.4);
            scene.add(windowFrame);

            const windowGlassGeometry = new THREE.BoxGeometry(1.8, 1.8, 0.1);
            const windowGlass = new THREE.Mesh(windowGlassGeometry, windowMaterial);
            windowGlass.position.set(0, 1.5, -2.45);
            scene.add(windowGlass);

            // Lumières
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.6);
            directionalLight.position.set(10, 10, 10);
            scene.add(directionalLight);
            
            const orbGeometry = new THREE.SphereGeometry(0.2, 32, 32);
            const orbMaterial = new THREE.MeshBasicMaterial({ color: 0x00ffff });
            const orbLight = new THREE.PointLight(0x00ffff, 1, 5);
            const orb1 = new THREE.Mesh(orbGeometry, orbMaterial);
            orb1.position.set(-2, 2.5, 2);
            orbLight.position.copy(orb1.position);
            scene.add(orb1);
            scene.add(orbLight);

            window.addEventListener('resize', onWindowResize, false);
            onWindowResize();
        }

        function onWindowResize() {
            if (!renderer) return;
            const canvas = document.getElementById('virtualTourCanvas');
            const width = canvas.clientWidth;
            const height = 400;
            camera.aspect = width / height;
            camera.updateProjectionMatrix();
            renderer.setSize(width, height);
        }

        function animate() {
            requestAnimationFrame(animate);
            if (controls) {
                controls.update();
            }
            if (renderer) {
                renderer.render(scene, camera);
            }
        }

        // --- 2. FONCTION POUR RENDRE LES ANNONCES SCRAPÉES ---
        function renderProperties(listings) {
            const container = document.getElementById('listings-container');
            const emptyState = document.getElementById('empty-state');
            container.innerHTML = ''; 

            if (listings.length === 0) {
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';

            listings.forEach(listing => {
                const cardHTML = `
                    <div class="listing-card bg-white rounded-3xl overflow-hidden shadow-lg hover-lift">
                        <!-- Image de l'annonce -->
                        <div class="w-full h-48 overflow-hidden rounded-t-3xl">
                            <img src="${listing.imageUrl}" 
                                onerror="this.onerror=null; this.src='https://placehold.co/400x300/cccccc/333333?text=Image+Non+Trouvée';"
                                alt="Photo de l'annonce : ${listing.title}" 
                                class="apartment-image">
                        </div>
                        
                        <div class="p-6">
                            <h3 class="text-xl font-bold text-gray-800 mb-2 truncate">${listing.title}</h3>
                            <p class="text-2xl font-extrabold text-blue-600 mb-3">${listing.price}</p>
                            
                            <!-- Description (limité à 3 lignes) -->
                            <p class="text-gray-500 text-sm mb-4 line-clamp-3">${listing.description}</p>
                            
                            <a href="${listing.link}" target="_blank" rel="noopener noreferrer" 
                               class="inline-block w-full text-center py-2 px-4 bg-blue-600 text-white font-semibold rounded-full hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-500 focus:ring-opacity-50 transition duration-150">
                                Voir l'annonce
                            </a>
                        </div>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', cardHTML);
            });
        }


        window.onload = function() {
            // Variables Firebase globales
            const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
            const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

            let db, auth;
            let userId = null;
            let isPremium = false;
            
            let visitCount = parseInt(localStorage.getItem('visitCount') || '0', 10);
            const MAX_PAID_VISITS = 4;

            // --- Fonctions d'exportation (simulant fs.writeFileSync) ---
            const generateCSV = (data) => {
                if (data.length === 0) return "";
                const headers = Object.keys(data[0]).join(',');
                const rows = data.map(obj => Object.values(obj).join(',')).join('\n');
                return headers + '\n' + rows;
            };

            const csvContent = generateCSV(scrapedListings);

            function downloadFile(filename, content, mimeType) {
                const blob = new Blob([content], { type: mimeType });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }

            window.exportData = function() {
                const jsonContent = JSON.stringify(scrapedListings, null, 2);
                downloadFile('maisons.json', jsonContent, 'application/json');
                downloadFile('maisons.csv', csvContent, 'text/csv;charset=utf-8');

                showMessage('Export Réussi', 'Les fichiers maisons.json et maisons.csv ont été générés et le téléchargement a été lancé.');
            }

            // --- Fonctions de modales et d'UX ---
            window.showMessage = function(title, content) {
                document.getElementById('message-title').textContent = title;
                document.getElementById('message-content').textContent = content;
                document.getElementById('message-box').style.display = 'block';
            }
            window.closeMessage = function() {
                document.getElementById('message-box').style.display = 'none';
            }

            window.showConfirmationBox = function(title, content) {
                document.getElementById('confirmation-title').textContent = title;
                document.getElementById('confirmation-content').textContent = content;
                document.getElementById('confirmation-box').style.display = 'block';
            }
            window.closeConfirmationBox = function() {
                document.getElementById('confirmation-box').style.display = 'none';
            }

            const authModal = document.getElementById('auth-modal');
            const loginTabBtn = document.getElementById('login-tab');
            const signupTabBtn = document.getElementById('signup-tab');
            const loginForm = document.getElementById('login-form');
            const signupForm = document.getElementById('signup-form');

            window.openAuthModal = function(formType) {
                authModal.classList.remove('hidden');
                if (formType === 'Connexion') { showForm('login'); } else { showForm('signup'); }
            }

            window.closeAuthModal = function() {
                authModal.classList.add('hidden');
            }

            function showForm(formId) {
                document.querySelectorAll('.auth-tab-btn').forEach(btn => btn.classList.remove('active', 'bg-gray-200'));
                document.querySelectorAll('.auth-form').forEach(form => form.classList.add('hidden'));
                if (formId === 'login') {
                    loginTabBtn.classList.add('active', 'bg-gray-200');
                    loginForm.classList.remove('hidden');
                } else {
                    signupTabBtn.classList.add('active', 'bg-gray-200');
                    signupForm.classList.remove('hidden');
                }
            }

            loginTabBtn.addEventListener('click', () => showForm('login'));
            signupTabBtn.addEventListener('click', () => showForm('signup'));
            
            function handleTabDisplay(tabId, newTabContent) {
                if (tabId === 'virtual-tour') {
                    if (renderer) { renderer.dispose(); renderer = null; }
                    
                    if (isPremium) {
                        if (visitCount < MAX_PAID_VISITS) {
                            visitCount++;
                            localStorage.setItem('visitCount', visitCount.toString());
                            newTabContent.classList.remove('hidden');
                            newTabContent.classList.add('fade-in-slide');

                            showMessage('Visite virtuelle (Accès Payant)', `Ceci est votre visite numéro ${visitCount} sur ${MAX_PAID_VISITS}. Il vous reste ${MAX_PAID_VISITS - visitCount} visites avec votre forfait actuel.`);
                            initThreeJS();
                            animate();
                        } else {
                            document.getElementById('premium-modal-content').textContent = "Vous avez utilisé vos 4 visites. Pour continuer, passez à l'abonnement Accès Total (5 000 FCFA/mois) ou renouvelez ce forfait 4 visites.";
                            showPremiumModal(true);
                            showMessage('Limite de visites atteinte', `Vous avez atteint la limite de ${MAX_PAID_VISITS} visites. Veuillez renouveler votre forfait ou passer au plan Accès Total pour un accès illimité.`);
                            showTab('properties');
                        }
                    } else {
                        document.getElementById('premium-modal-content').textContent = "Accédez instantanément à la visite virtuelle en payant le forfait Essai 3D à 2 500 FCFA. Ce forfait vous donne droit à 4 visites.";
                        showPremiumModal(true);
                        showMessage('Accès restreint', 'L\'accès aux visites 3D nécessite le forfait Essai 3D (2500 FCFA) ou l\'abonnement Accès Total.');
                        showTab('properties');
                    }
                } else {
                    newTabContent.classList.remove('hidden');
                    newTabContent.classList.add('fade-in-slide');
                    if (renderer) { renderer.dispose(); renderer = null; }
                }
            }


            window.showTab = function(tabId) {
                const activeTabContent = document.querySelector('.tab-content:not(.hidden)');
                const newTabContent = document.getElementById(tabId);
                
                document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                document.querySelector(`[onclick="showTab('${tabId}')"]`).classList.add('active');

                if (activeTabContent === newTabContent) return;

                if (activeTabContent) {
                    activeTabContent.classList.add('fade-out-slide');
                    activeTabContent.classList.remove('fade-in-slide');

                    setTimeout(() => {
                        activeTabContent.classList.add('hidden');
                        activeTabContent.classList.remove('fade-out-slide');
                        handleTabDisplay(tabId, newTabContent);
                    }, 300);
                } else {
                    handleTabDisplay(tabId, newTabContent);
                }
            };
            
            const searchInput = document.getElementById('search-input');
            const searchButton = document.getElementById('search-button');

            searchButton.addEventListener('click', () => {
                const query = searchInput.value.trim();
                if (query) {
                    showMessage('Aucune offre disponible', `Il n'y a pas encore d'offres pour "${query}". Réessayez plus tard !`);
                } else {
                    showMessage('Recherche vide', 'Veuillez entrer une ville ou un quartier pour lancer la recherche.');
                }
            });

            const premiumModal = document.getElementById('premium-modal');

            window.showPremiumModal = function(forceShow = false) {
                if (forceShow) { premiumModal.style.display = 'block'; }
            }

            window.closePremiumModal = function() {
                premiumModal.style.display = 'none';
            }
            
            const subscriptionPhoneInput = document.getElementById('subscription-phone');
            const validateSubscriptionButton = document.getElementById('validate-subscription-button');

            validateSubscriptionButton.addEventListener('click', async () => {
                const phoneNumber = subscriptionPhoneInput.value.trim();
                if (!phoneNumber || phoneNumber.length < 8) {
                    showMessage("Numéro de téléphone manquant", "Veuillez entrer un numéro de téléphone valide.");
                    return;
                }

                closePremiumModal();
                showConfirmationBox("Demande de vérification", "Nous traitons votre paiement (simulation). Si le paiement réussit, votre accès sera mis à jour.");

                await new Promise(resolve => setTimeout(resolve, 2000));
                
                if (userId) {
                    try {
                        const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/profile/data`);
                        
                        await setDoc(userDocRef, { 
                            isPremium: true,
                            subscriptionType: 'Essai 3D (4 visites)',
                            lastPayment: new Date().toISOString()
                        }, { merge: true });
                        
                        localStorage.setItem('visitCount', '0');
                        visitCount = 0;

                        showMessage("Abonnement activé !", "Félicitations ! Votre forfait Essai 3D (4 visites) est activé. Vous pouvez maintenant explorer en 3D.");
                        isPremium = true; 
                    } catch(e) {
                        console.error("Erreur lors de la mise à jour Firestore:", e);
                        showMessage("Erreur", "Une erreur est survenue lors de l'activation de votre accès.");
                    }
                } else {
                    showMessage("Erreur d'authentification", "Veuillez vous connecter pour activer votre forfait.");
                }
            });

            const closePremiumButton = document.getElementById('close-premium-button');
            closePremiumButton.addEventListener('click', closePremiumModal);

            // --- Initialisation de Firebase ---
            initializeApp(firebaseConfig);
            auth = getAuth();
            db = getFirestore();

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/profile/data`);
                    onSnapshot(userDocRef, (docSnap) => {
                        if (docSnap.exists()) {
                            const data = docSnap.data();
                            isPremium = data.isPremium || false;
                        } else {
                            isPremium = false;
                        }
                    }, (error) => {
                        console.error('Erreur lors de l\'écoute des données utilisateur :', error);
                    });

                } else {
                    userId = null;
                    isPremium = false;
                }
            });

            async function handleCustomAuth() {
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Erreur d'authentification Firebase :", error);
                }
            }
            handleCustomAuth();
            
            // --- EXÉCUTION AU CHARGEMENT ---
            renderProperties(scrapedListings); // Affiche les annonces scrapées
            showTab('properties'); // Affiche l'onglet par défaut au chargement
        };
    </script>
</body>
</html>
